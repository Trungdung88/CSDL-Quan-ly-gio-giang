<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý và Điểm danh (Google Drive)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); transition: opacity 0.3s ease; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 24px; border: 1px solid #888; width: 95%; max-width: 800px; border-radius: 0.5rem; transform: translateY(-50px); transition: transform 0.3s ease; }
        .modal.show .modal-content { transform: translateY(0); }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        #auth-container button { transition: all 0.2s ease-in-out; }
        
        /* Tab styles */
        .tab-button {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #6b7280;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Report table styles */
        .report-table-container {
            width: 100%;
            overflow-x: auto;
            max-height: 600px;
        }
        .report-table {
            min-width: 1200px;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .report-table th, .report-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            text-align: center;
            min-width: 50px;
        }
        .report-table th {
            background-color: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .report-table td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background-color: #fff;
            min-width: 150px;
            z-index: 11;
        }
        .report-table th:first-child {
            left: 0;
            z-index: 12;
        }
        .report-present {
            color: #16a34a; /* green */
            font-weight: bold;
        }
        .report-absent {
            color: #dc2626; /* red */
            font-weight: bold;
        }
        .report-weekend {
            background-color: #f3f4f6;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="text-center mb-6 border-b pb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700">Hệ thống Quản lý và Điểm danh Lớp học</h1>
            <p class="text-gray-600 mt-2">Lưu trữ và đồng bộ dữ liệu với Google Drive</p>
            
            <!-- Vùng xác thực Google -->
            <div id="auth-container" class="mt-4 flex items-center justify-center space-x-4">
                <button id="authorize_button" class="bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center space-x-2">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    <span>Đăng nhập với Google</span>
                </button>
                <button id="signout_button" class="hidden bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-600">Đăng xuất</button>
                <div id="user-profile" class="hidden flex items-center space-x-2">
                    <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="User Avatar">
                    <span id="user-name" class="text-sm font-medium text-gray-700"></span>
                </div>
            </div>
            <div id="drive-status" class="mt-2 text-sm text-gray-500 h-5">Vui lòng đăng nhập để bắt đầu.</div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cột trái: Nhập liệu và Lưu trữ -->
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Nhập liệu Hệ thống</h2>
                    <div class="space-y-3 mb-6">
                        <h3 class="font-semibold text-gray-700">1. Nhập Danh sách Phân công</h3>
                        <a href="#" id="download-teacher-template" class="text-sm text-blue-600 hover:underline">Tải file mẫu Giáo viên</a>
                        <input type="file" id="teacher-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <button id="import-teacher-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700" disabled>Nhập Phân công</button>
                    </div>
                    <div class="space-y-3 border-t pt-6">
                        <h3 class="font-semibold text-gray-700">2. Nhập Danh sách Học sinh</h3>
                        <a href="#" id="download-student-template" class="text-sm text-green-600 hover:underline">Tải file mẫu Học sinh</a>
                        <input type="file" id="student-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                        <button id="import-student-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700" disabled>Nhập Học sinh</button>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Đồng bộ Dữ liệu</h2>
                    <button id="save-to-drive-btn" class="w-full bg-purple-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-purple-700 flex items-center justify-center space-x-2" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span>Lưu ngay lập tức</span>
                    </button>
                    <p class="text-xs text-center mt-2 text-gray-500">Ứng dụng sẽ tự động lưu sau mỗi thay đổi.</p>
                </div>
            </div>
            
            <!-- Cột phải: Vận hành & Báo cáo (với Tabs) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <!-- Tab Headers -->
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px" aria-label="Tabs">
                        <button class="tab-button active" data-tab-target="#tab-diemdanh">Điểm danh</button>
                        <button class="tab-button" data-tab-target="#tab-baocao">Báo cáo Tháng</button>
                    </nav>
                </div>

                <!-- Tab Content: Điểm danh -->
                <div id="tab-diemdanh" class="tab-content active mt-6">
                    <h2 class="text-xl font-semibold mb-4">Vận hành & Điểm danh</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold mb-2">Chọn Giáo viên</h3>
                            <div class="max-h-96 overflow-y-auto border rounded-lg">
                                <ul id="teacher-list" class="divide-y divide-gray-200">
                                   <li class="p-4 text-center text-gray-500">Chưa có dữ liệu giáo viên.</li>
                                </ul>
                            </div>
                        </div>
                        <div id="schedule-section">
                            <h3 class="font-semibold mb-2">Lịch trình của <span id="selected-teacher-name" class="text-blue-600">...</span></h3>
                            <div id="schedule-container" class="max-h-96 overflow-y-auto border rounded-lg p-3 space-y-3 bg-gray-50">
                               <p class="p-4 text-center text-gray-500">Vui lòng chọn một giáo viên.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8">
                         <h3 class="text-xl font-semibold mb-4 border-b pb-2">Báo cáo Nhanh Chuyên cần</h3>
                         <div class="max-h-96 overflow-y-auto border rounded-lg">
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MSHS</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Họ và Tên</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lớp</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng ngày vắng</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-report" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="p-4 text-center text-gray-500">Chưa có dữ liệu.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Báo cáo Tháng -->
                <div id="tab-baocao" class="tab-content mt-6">
                    <h2 class="text-xl font-semibold mb-4">Báo cáo & Thống kê Chi tiết</h2>
                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                        <div>
                            <label for="report-month" class="block text-sm font-medium text-gray-700">Chọn Tháng</label>
                            <input type="month" id="report-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="report-class" class="block text-sm font-medium text-gray-700">Chọn Lớp</label>
                            <select id="report-class" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="">Tất cả</option>
                            </select>
                        </div>
                        <button id="generate-report-btn" class="self-end w-full md:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Xem Báo cáo</button>
                    </div>

                    <!-- Report Content -->
                    <div id="report-content-container" class="hidden space-y-6">
                        <!-- Monthly Stats -->
                        <h3 class="text-lg font-semibold">Tổng kết tháng</h3>
                        <div id="report-stats-monthly" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Stats will be injected here -->
                        </div>
                        
                        <!-- Report Table -->
                        <h3 class="text-lg font-semibold">Bảng điểm danh chi tiết</h3>
                        <div id="report-table-container" class="report-table-container">
                            <table class="report-table">
                                <thead id="report-table-head">
                                    <!-- Header row will be injected here -->
                                </thead>
                                <tbody id="report-table-body">
                                    <!-- Student rows will be injected here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Weekly Stats -->
                        <h3 class="text-lg font-semibold">Thống kê theo Tuần</h3>
                        <div id="report-stats-weekly" class="space-y-4">
                            <!-- Weekly stats will be injected here -->
                        </div>
                    </div>
                    <div id="report-placeholder" class="text-center text-gray-500 py-10">
                        Vui lòng chọn tháng và lớp để xem báo cáo.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Điểm danh (giữ nguyên) -->
    <div id="attendance-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold">Điểm danh Lớp</h3>
                <span class="close-button" id="modal-close-btn">&times;</span>
            </div>
            <div id="modal-body" class="mb-4">
                <div class="grid grid-cols-3 gap-4 text-center mb-4">
                    <div class="bg-gray-100 p-3 rounded-lg"><h4 class="font-bold text-gray-700">Sĩ số</h4><p id="stat-total" class="text-2xl font-bold text-gray-900">0</p></div>
                    <div class="bg-green-100 p-3 rounded-lg"><h4 class="font-bold text-green-700">Hiện diện</h4><p id="stat-present" class="text-2xl font-bold text-green-600">0</p></div>
                    <div class="bg-red-100 p-3 rounded-lg"><h4 class="font-bold text-red-700">Vắng</h4><p id="stat-absent" class="text-2xl font-bold text-red-500">0</p></div>
                </div>
                <div class="max-h-[40vh] overflow-y-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                             <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">MSHS</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Họ và Tên</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Vắng</th>
                            </tr>
                        </thead>
                        <tbody id="student-attendance-list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-md hover:bg-gray-300">Hủy</button>
                <button id="modal-save-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Lưu Điểm danh</button>
            </div>
        </div>
    </div>

    <script>
    // --- CONFIGURATION ---
    const CLIENT_ID = 'YOUR_CLIENT_ID'; // Thay bằng Client ID của bạn
    const API_KEY = 'YOUR_API_KEY'; // Thay bằng API Key của bạn
    const DRIVE_FOLDER_ID = '1pUczdnJuyzVzPAO2eplvOCJO7d-d_xkh'; // ID thư mục từ link của bạn
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    // --- GLOBAL VARIABLES & STATE ---
    let tokenClient;
    let gapiInited = false, gisInited = false;
    let teachers = [], students = [], attendanceRecords = [];
    let fileMetas = {}; 
    let selectedTeacherId = null, currentAttendanceSession = {};
    let debounceTimer = null; // Timer for auto-save

    // --- DOM ELEMENTS ---
    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');
    const userProfile = document.getElementById('user-profile');
    const driveStatus = document.getElementById('drive-status');
    const importTeacherBtn = document.getElementById('import-teacher-btn');
    const importStudentBtn = document.getElementById('import-student-btn');
    const saveToDriveBtn = document.getElementById('save-to-drive-btn');
    const teacherListEl = document.getElementById('teacher-list');
    const selectedTeacherNameEl = document.getElementById('selected-teacher-name');
    const scheduleContainerEl = document.getElementById('schedule-container');
    const attendanceReportEl = document.getElementById('attendance-report');
    const modal = document.getElementById('attendance-modal');
    const studentAttendanceListEl = document.getElementById('student-attendance-list');
    const statTotalEl = document.getElementById('stat-total'), statPresentEl = document.getElementById('stat-present'), statAbsentEl = document.getElementById('stat-absent');
    
    // --- NEW REPORT DOM ELEMENTS ---
    const reportMonthInput = document.getElementById('report-month');
    const reportClassSelect = document.getElementById('report-class');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const reportContentContainer = document.getElementById('report-content-container');
    const reportPlaceholder = document.getElementById('report-placeholder');
    const reportTableHead = document.getElementById('report-table-head');
    const reportTableBody = document.getElementById('report-table-body');
    const reportStatsMonthly = document.getElementById('report-stats-monthly');
    const reportStatsWeekly = document.getElementById('report-stats-weekly');


    // --- GOOGLE API INITIALIZATION ---
    window.gapiLoaded = () => { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
        gapiInited = true; maybeEnableButtons();
    }
    window.gisLoaded = () => {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '',
        });
        gisInited = true; 
        
        // SỬA LỖI: Di chuyển trình xử lý onclick vào đây.
        // Điều này đảm bảo tokenClient luôn được định nghĩa
        // TRƯỚC KHI chúng ta gán sự kiện click cho nút.
        authorizeButton.onclick = () => {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { throw (resp); }
                await updateUIOnAuth();
                await loadDataFromDrive();
            };
            if (gapi.client.getToken() === null) { tokenClient.requestAccessToken({prompt: 'consent'}); } 
            else { tokenClient.requestAccessToken({prompt: ''}); }
        };
        
        maybeEnableButtons();
    }
    function maybeEnableButtons() {
        if (gapiInited && gisInited) { authorizeButton.style.visibility = 'visible'; }
    }
    
    // --- AUTHENTICATION LOGIC ---
    // ĐÃ DI CHUYỂN authorizeButton.onclick LÊN TRÊN VÀO HÀM gisLoaded
    
    signoutButton.onclick = () => {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            updateUIOnAuth();
            teachers = []; students = []; attendanceRecords = []; fileMetas = {}; renderAll();
        }
    };
    async function updateUIOnAuth() {
        const token = gapi.client.getToken();
        const isLoggedIn = !!token;
        authorizeButton.classList.toggle('hidden', isLoggedIn);
        signoutButton.classList.toggle('hidden', !isLoggedIn);
        userProfile.classList.toggle('hidden', !isLoggedIn);
        importTeacherBtn.disabled = !isLoggedIn;
        importStudentBtn.disabled = !isLoggedIn;
        saveToDriveBtn.disabled = !isLoggedIn;

        if (isLoggedIn) {
            const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { 'Authorization': `Bearer ${token.access_token}` }
            });
            const userInfo = await response.json();
            document.getElementById('user-avatar').src = userInfo.picture;
            document.getElementById('user-name').textContent = userInfo.given_name;
            driveStatus.textContent = 'Đã đăng nhập. Sẵn sàng tải dữ liệu.';
        } else {
            driveStatus.textContent = 'Vui lòng đăng nhập để bắt đầu.';
        }
    }

    // --- GOOGLE DRIVE API & AUTO-SAVE FUNCTIONS ---
    const DATA_FILES = {
        teachers: 'teachers_v2.json',
        students: 'students_v2.json',
        attendance: 'attendanceRecords_v2.json',
    };

    function triggerAutoSave() {
        clearTimeout(debounceTimer);
        driveStatus.textContent = 'Dữ liệu đã thay đổi, sẽ tự động lưu sau 3 giây...';
        debounceTimer = setTimeout(() => {
            saveDataToDrive(true);
        }, 3000);
    }

    async function saveDataToDrive(isAuto = false) {
        if (!gapi.client.getToken()) {
            if (!isAuto) alert("Vui lòng đăng nhập trước khi lưu.");
            return;
        }
        clearTimeout(debounceTimer);
        driveStatus.textContent = `${isAuto ? 'Đang tự động lưu' : 'Đang lưu'} dữ liệu...`;
        saveToDriveBtn.disabled = true;

        try {
            await Promise.all([
                saveFileContent(fileMetas.teachers, teachers),
                saveFileContent(fileMetas.students, students),
                saveFileContent(fileMetas.attendance, attendanceRecords)
            ]);
            driveStatus.textContent = `Đã lưu thành công! (${new Date().toLocaleTimeString()})`;
        } catch (error) {
            driveStatus.textContent = 'Lỗi! Không thể lưu dữ liệu.';
            console.error("Save error:", error);
        } finally {
            saveToDriveBtn.disabled = false;
            setTimeout(() => {
                if (driveStatus.textContent.includes('Đã lưu thành công')) {
                    driveStatus.textContent = 'Hệ thống đã sẵn sàng.';
                }
            }, 5000);
        }
    }
    
    async function loadDataFromDrive() {
        driveStatus.textContent = 'Đang tải dữ liệu từ Google Drive...';
        try {
            fileMetas.teachers = await findOrCreateFile(DATA_FILES.teachers);
            fileMetas.students = await findOrCreateFile(DATA_FILES.students);
            fileMetas.attendance = await findOrCreateFile(DATA_FILES.attendance);

            const [teachersContent, studentsContent, attendanceContent] = await Promise.all([
                readFileContent(fileMetas.teachers),
                readFileContent(fileMetas.students),
                readFileContent(fileMetas.attendance)
            ]);

            teachers = teachersContent || [];
            students = studentsContent || [];
            attendanceRecords = attendanceContent || [];
            driveStatus.textContent = 'Tải dữ liệu thành công. Hệ thống đã sẵn sàng.';
            
            // Khởi tạo bộ lọc báo cáo sau khi tải dữ liệu
            initReportFilters();

        } catch(error){
            driveStatus.textContent = 'Lỗi khi tải dữ liệu từ Drive.';
            console.error("Load error:", error);
        }
        renderAll();
    }

    async function findOrCreateFile(fileName) { /* ... (Giữ nguyên) ... */ }
    async function readFileContent(fileId) { /* ... (Giữ nguyên) ... */ }
    async function saveFileContent(fileId, content) { /* ... (Giữ nguyên) ... */ }
    // --- (Sao chép 3 hàm findOrCreateFile, readFileContent, saveFileContent từ phiên bản trước) ---
    async function findOrCreateFile(fileName) {
         try {
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name='${fileName}' and trashed=false`,
                fields: 'files(id, name)',
            });
            if (response.result.files && response.result.files.length > 0) {
                return response.result.files[0].id;
            } else {
                const fileMetadata = { name: fileName, parents: [DRIVE_FOLDER_ID], mimeType: 'application/json' };
                const createResponse = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                return createResponse.result.id;
            }
        } catch (err) {
            console.error("Error finding or creating file", err);
            driveStatus.textContent = `Lỗi: ${err.result?.error?.message || 'Không xác định'}`;
            return null;
        }
    }
    async function readFileContent(fileId) {
        if (!fileId) return null;
        try {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            return response.result;
        } catch (err) {
            if (err.status === 404 || JSON.stringify(err.result).includes("File not found")) { return null; }
            console.error("Error reading file content", err); return null;
        }
    }
    async function saveFileContent(fileId, content) {
        if (!fileId) return;
        const boundary = '-------314159265358979323846';
        const multipartRequestBody =
            `\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${JSON.stringify({mimeType: 'application/json'})}` +
            `\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${JSON.stringify(content)}` +
            `\r\n--${boundary}--`;
        await gapi.client.request({
            path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH',
            params: { uploadType: 'multipart' },
            headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` },
            body: multipartRequestBody,
        });
    }
    // --- (Hết 3 hàm) ---

    // --- APPLICATION LOGIC ---
    const showAlert = (message) => alert(message);
    const renderAll = () => { renderTeacherList(); renderSchedule(); renderAttendanceReport(); };
    
    // --- (Sao chép các hàm render... và logic modal từ phiên bản trước) ---
    const renderTeacherList = () => { teacherListEl.innerHTML = ''; if (teachers.length === 0) { teacherListEl.innerHTML = '<li class="p-4 text-center text-gray-500">Chưa có dữ liệu giáo viên.</li>'; return; } teachers.forEach(teacher => { const li = document.createElement('li'); li.className = `p-3 flex justify-between items-center cursor-pointer hover:bg-gray-100 ${selectedTeacherId === teacher.id ? 'bg-blue-100' : ''}`; li.dataset.teacherId = teacher.id; li.innerHTML = `<p class="font-semibold text-gray-800">${teacher.name}</p>`; li.addEventListener('click', () => { selectedTeacherId = teacher.id; renderAll(); }); teacherListEl.appendChild(li); }); };
    const renderSchedule = () => { scheduleContainerEl.innerHTML = ''; if (!selectedTeacherId) { scheduleContainerEl.innerHTML = '<p class="p-4 text-center text-gray-500">Vui lòng chọn một giáo viên.</p>'; selectedTeacherNameEl.textContent = '...'; return; } const teacher = teachers.find(t => t.id === selectedTeacherId); selectedTeacherNameEl.textContent = teacher.name; if (!teacher.assignments || teacher.assignments.length === 0) { scheduleContainerEl.innerHTML = '<p class="p-4 text-center text-gray-500">Giáo viên này chưa được phân công.</p>'; return; } teacher.assignments.forEach(assign => { const card = document.createElement('div'); card.className = 'bg-white p-4 rounded-lg border shadow-sm'; card.innerHTML = `<p class="font-bold text-lg">${assign.className}</p><p class="text-gray-600 text-sm">${assign.subject}</p><p class="text-gray-500 text-xs mt-1">${assign.schedule}</p><button data-class-name="${assign.className}" data-subject="${assign.subject}" class="mt-3 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 text-sm">Điểm danh</button>`; card.querySelector('button').addEventListener('click', () => { openAttendanceModal(teacher, assign); }); scheduleContainerEl.appendChild(card); }); };
    const renderAttendanceReport = () => { attendanceReportEl.innerHTML = ''; if (students.length === 0) { attendanceReportEl.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Chưa có dữ liệu học sinh.</td></tr>`; return; } const sortedStudents = [...students].sort((a,b) => a.name.localeCompare(b.name)); sortedStudents.forEach(student => { const totalAbsences = attendanceRecords.filter(rec => rec.absent.some(abs => abs.studentId === student.id)).length; const tr = document.createElement('tr'); tr.innerHTML = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${student.id}</td><td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${student.className}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold ${totalAbsences > 0 ? 'text-red-600' : 'text-green-600'}">${totalAbsences}</td>`; attendanceReportEl.appendChild(tr); }); };
    const openAttendanceModal = (teacher, assignment) => { currentAttendanceSession = { teacherId: teacher.id, date: new Date().toISOString().split('T')[0], assignment: assignment, absent: [] }; document.getElementById('modal-title').textContent = `Điểm danh ${assignment.className} - ${assignment.subject}`; const classStudents = students.filter(s => s.className === assignment.className); studentAttendanceListEl.innerHTML = ''; if (classStudents.length === 0) { studentAttendanceListEl.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">Lớp này chưa có học sinh.</td></tr>`; } classStudents.forEach(student => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="px-4 py-3 text-sm text-gray-500">${student.id}</td><td class="px-4 py-3 text-sm text-gray-900">${student.name}</td><td class="px-4 py-3 text-center"><input type="checkbox" data-student-id="${student.id}" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500"></td>`; studentAttendanceListEl.appendChild(tr); }); updateAttendanceStats(classStudents.length); modal.style.display = 'block'; setTimeout(() => modal.classList.add('show'), 10); };
    const updateAttendanceStats = (total) => { const absentCount = studentAttendanceListEl.querySelectorAll('input[type="checkbox"]:checked').length; statTotalEl.textContent = total; statPresentEl.textContent = total - absentCount; statAbsentEl.textContent = absentCount; };
    const closeAttendanceModal = () => { modal.classList.remove('show'); setTimeout(() => modal.style.display = 'none', 300); };
    const downloadExcelTemplate = (sampleData, fileName) => { const ws = XLSX.utils.json_to_sheet(sampleData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, fileName); };
    const handleFileUpload = (file, callback) => { if (!file) { showAlert('Vui lòng chọn một file.'); return; } const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; callback(XLSX.utils.sheet_to_json(worksheet)); } catch (error) { console.error("Error processing Excel file:", error); showAlert('Lỗi xử lý file. Vui lòng kiểm tra định dạng file và các tiêu đề cột.'); } }; reader.readAsArrayBuffer(file); };
    // --- (Hết) ---

    // --- NEW REPORTING LOGIC ---
    function initReportFilters() {
        // Set default month to current month
        reportMonthInput.value = new Date().toISOString().slice(0, 7);

        // Populate class filter
        const classNames = [...new Set(students.map(s => s.className))].sort();
        reportClassSelect.innerHTML = '<option value="">Chọn một lớp</option>';
        classNames.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            reportClassSelect.appendChild(option);
        });
    }

    function getDaysInMonth(year, month) {
        return new Date(year, month, 0).getDate();
    }

    function generateReport() {
        const monthValue = reportMonthInput.value;
        const selectedClass = reportClassSelect.value;

        if (!monthValue || !selectedClass) {
            showAlert("Vui lòng chọn tháng và lớp để xem báo cáo.");
            return;
        }

        reportPlaceholder.classList.add('hidden');
        reportContentContainer.classList.remove('hidden');

        const [year, month] = monthValue.split('-').map(Number);
        const daysInMonth = getDaysInMonth(year, month);
        
        // 1. Get relevant students and records
        const classStudents = students.filter(s => s.className === selectedClass).sort((a,b) => a.name.localeCompare(b.name));
        const monthRecords = attendanceRecords.filter(rec => {
            const recDate = new Date(rec.date);
            return rec.assignment.className === selectedClass &&
                   recDate.getFullYear() === year &&
                   (recDate.getMonth() + 1) === month;
        });

        // 2. Generate Table Header
        reportTableHead.innerHTML = '';
        const headerRow = document.createElement('tr');
        let headerHTML = '<th>Học sinh</th>';
        for (let day = 1; day <= daysInMonth; day++) {
            headerHTML += `<th>${day}</th>`;
        }
        headerHTML += '<th>Vắng (Tổng)</th>';
        headerRow.innerHTML = headerHTML;
        reportTableHead.appendChild(headerRow);

        // 3. Generate Table Body and collect stats
        reportTableBody.innerHTML = '';
        let totalAbsencesMonth = 0;
        let totalSchoolDays = 0;
        const weeklyStats = [
            { week: 1, absences: 0, days: 0 },
            { week: 2, absences: 0, days: 0 },
            { week: 3, absences: 0, days: 0 },
            { week: 4, absences: 0, days: 0 },
            { week: 5, absences: 0, days: 0 },
            { week: 6, absences: 0, days: 0 }
        ];

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday or Saturday
                totalSchoolDays++;
                const weekNumber = Math.ceil((date.getDate() + (new Date(year, month - 1, 1).getDay()) - 1) / 7);
                if(weeklyStats[weekNumber-1]) weeklyStats[weekNumber-1].days++;
            }
        }

        classStudents.forEach(student => {
            const studentRow = document.createElement('tr');
            let rowHTML = `<td>${student.name} (${student.id})</td>`;
            let studentTotalAbsences = 0;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                const dateString = date.toISOString().split('T')[0];

                let cellContent = '-';
                let cellClass = '';
                
                if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                    cellContent = 'WE'; // Weekend
                    cellClass = 'report-weekend';
                } else {
                    const recordForDay = monthRecords.find(rec => rec.date === dateString);
                    if (recordForDay) {
                        const isAbsent = recordForDay.absent.some(abs => abs.studentId === student.id);
                        if (isAbsent) {
                            cellContent = 'X';
                            cellClass = 'report-absent';
                            studentTotalAbsences++;
                            totalAbsencesMonth++;
                            // Add to weekly stats
                            const weekNumber = Math.ceil((date.getDate() + (new Date(year, month - 1, 1).getDay()) - 1) / 7);
                            if(weeklyStats[weekNumber-1]) weeklyStats[weekNumber-1].absences++;
                        } else {
                            cellContent = 'V';
                            cellClass = 'report-present';
                        }
                    } else {
                        cellContent = '?'; // No record for this day
                    }
                }
                rowHTML += `<td class="${cellClass}">${cellContent}</td>`;
            }
            rowHTML += `<td>${studentTotalAbsences}</td>`;
            studentRow.innerHTML = rowHTML;
            reportTableBody.appendChild(studentRow);
        });

        // 4. Render Stats
        // Monthly
        const totalPossibleAttendances = totalSchoolDays * classStudents.length;
        const attendanceRate = totalPossibleAttendances > 0 ? (((totalPossibleAttendances - totalAbsencesMonth) / totalPossibleAttendances) * 100).toFixed(1) : 'N/A';
        reportStatsMonthly.innerHTML = `
            <div class="p-4 bg-gray-100 rounded-lg">
                <div class="text-sm font-medium text-gray-500">Tổng Lượt Vắng</div>
                <div class="text-2xl font-bold text-red-600">${totalAbsencesMonth}</div>
            </div>
            <div class="p-4 bg-gray-100 rounded-lg">
                <div class="text-sm font-medium text-gray-500">Số ngày học</div>
                <div class="text-2xl font-bold text-gray-900">${totalSchoolDays}</div>
            </div>
            <div class="p-4 bg-gray-100 rounded-lg">
                <div class="text-sm font-medium text-gray-500">Sĩ số Lớp</div>
                <div class="text-2xl font-bold text-gray-900">${classStudents.length}</div>
            </div>
            <div class="p-4 bg-green-100 rounded-lg">
                <div class="text-sm font-medium text-green-700">Tỷ lệ Chuyên cần</div>
                <div class="text-2xl font-bold text-green-600">${attendanceRate}%</div>
            </div>
        `;

        // Weekly
        reportStatsWeekly.innerHTML = '';
        weeklyStats.forEach((week, index) => {
            if (week.days > 0) {
                const weekPossible = week.days * classStudents.length;
                const weekRate = weekPossible > 0 ? (((weekPossible - week.absences) / weekPossible) * 100).toFixed(1) : 'N/A';
                reportStatsWeekly.innerHTML += `
                    <div class="p-4 bg-white border rounded-lg grid grid-cols-3 gap-4">
                        <div class="font-semibold text-gray-800">Tuần ${index + 1}</div>
                        <div>
                            <span class="text-sm text-gray-500">Lượt vắng:</span>
                            <span class="font-bold text-red-600">${week.absences}</span>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">Chuyên cần:</span>
                            <span class="font-bold text-green-600">${weekRate}%</span>
                        </div>
                    </div>
                `;
            }
        });
    }

    // --- EVENT LISTENERS ---
    saveToDriveBtn.addEventListener('click', () => saveDataToDrive(false));
    
    document.getElementById('import-teacher-btn').addEventListener('click', () => {
        const fileInput = document.getElementById('teacher-file-input');
        handleFileUpload(fileInput.files[0], (json) => {
            const groupedTeachers = {};
            json.forEach(row => {
                const name = row.HoVaTen?.trim();
                if (!name) return;
                if (!groupedTeachers[name]) {
                    groupedTeachers[name] = { id: 'T' + Math.random().toString(36).substr(2, 9), name: name, assignments: [] };
                }
                groupedTeachers[name].assignments.push({
                    subject: row.MonDay?.trim() || 'N/A',
                    className: row.LopDay?.trim() || 'N/A',
                    schedule: row.ThoiGianGiangDay?.trim() || 'N/A'
                });
            });
            teachers = Object.values(groupedTeachers);
            renderAll();
            initReportFilters(); // Cập nhật bộ lọc
            showAlert(`Đã nhập ${teachers.length} giáo viên.`);
            fileInput.value = '';
            triggerAutoSave();
        });
    });
    
    document.getElementById('import-student-btn').addEventListener('click', () => {
         const fileInput = document.getElementById('student-file-input');
         handleFileUpload(fileInput.files[0], (json) => {
            students = json.map(row => ({
                id: row.MaSoHsinh?.toString().trim() || row.MaSoHocSinh?.toString().trim(),
                name: row.HoVaTen?.trim(),
                dob: row.NgaySinh?.toString().trim() || 'N/A',
                className: row.Lop?.toString().trim()
            })).filter(s => s.id && s.name && s.className);
            renderAll();
            initReportFilters(); // Cập nhật bộ lọc
            showAlert(`Đã nhập ${students.length} học sinh.`);
            fileInput.value = '';
            triggerAutoSave();
         });
    });
    
    document.getElementById('modal-save-btn').addEventListener('click', () => {
        const absentCheckboxes = studentAttendanceListEl.querySelectorAll('input[type="checkbox"]:checked');
        currentAttendanceSession.absent = Array.from(absentCheckboxes).map(cb => ({ studentId: cb.dataset.studentId, note: '' }));
        currentAttendanceSession.id = 'ATT' + Date.now();
        attendanceRecords = attendanceRecords.filter(rec => 
            !(rec.date === currentAttendanceSession.date && rec.teacherId === currentAttendanceSession.teacherId && rec.assignment.className === currentAttendanceSession.assignment.className)
        );
        attendanceRecords.push(currentAttendanceSession);
        renderAll();
        closeAttendanceModal();
        showAlert('Đã lưu điểm danh thành công!');
        triggerAutoSave();
    });
    
    document.getElementById('download-teacher-template').addEventListener('click', e => { e.preventDefault(); downloadExcelTemplate([{ STT: 1, HoVaTen: "Nguyễn Văn A", MonDay: "Toán", LopDay: "10A1", ThoiGianGiangDay: "Sáng Thứ 2 (Tiết 1,2)"}], 'Mau_DanhSachGiaoVien.xlsx'); });
    document.getElementById('download-student-template').addEventListener('click', e => { e.preventDefault(); downloadExcelTemplate([{ STT: 1, MaSoHocSinh: "HS001", HoVaTen: "Lê Thị C", NgaySinh: "2008-05-10", Lop: "10A1"}], 'Mau_DanhSachHocSinh.xlsx'); });
    studentAttendanceListEl.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { updateAttendanceStats(studentAttendanceListEl.querySelectorAll('tr').length); } });
    document.getElementById('modal-close-btn').onclick = closeAttendanceModal;
    document.getElementById('modal-cancel-btn').onclick = closeAttendanceModal;

    // --- NEW TAB AND REPORT LISTENERS ---
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            button.classList.add('active');
            document.querySelector(button.dataset.tabTarget).classList.add('active');
        });
    });

    generateReportBtn.addEventListener('click', generateReport);

    </script>

    <!-- Tải các script của Google SAU KHI script chính đã định nghĩa các hàm callback -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded"></script>

</body>
</html>



